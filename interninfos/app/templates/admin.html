{% extends "base.html" %}
{% block title %}Admin Dashboard | ReviewSense{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark shadow-sm" style="background: linear-gradient(90deg, #18132b 80%, #4B0082 100%); font-family: 'Poppins', sans-serif; position: fixed; top: 0; width: 100%; z-index: 1000;">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-white" style="font-size: 1.7rem; letter-spacing: 1px;">
      <img src="https://cdn-icons-png.flaticon.com/512/1946/1946429.png" alt="Logo" width="32" class="me-2 align-middle">ReviewSense Admin
    </a>
    <div class="d-flex ms-auto">
      <a class="btn btn-outline-light" href="{{ url_for('main.logout') }}">Logout</a>
    </div>
  </div>
</nav>
{% endblock %}

{% block content %}
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: #e0e0e0;
      min-height: 100vh;
      overflow-x: hidden; /* Prevent horizontal overflow */
      padding-top: 60px; /* Account for fixed navbar height */
    }
    .container {
      max-width: 100%;
      margin: 0;
      overflow-x: hidden; /* Prevent horizontal overflow */
    }
    .main-content {
      padding: 100px 1.5rem 1.5rem;
    }

    .horizontal-nav {
      position: fixed;
      top: 60px;
      left: 0;
      width: 100%;
      background: #e3f2fd;
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      border-bottom: 2px solid #2196f3;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      z-index: 999;
    }
    .horizontal-nav-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border: none;
      font-weight: 600;
      color: #333;
      border-radius: 6px;
      transition: background-color 0.3s, color 0.3s;
      text-align: center;
      flex: 1;
      max-width: 200px;
    }
    .horizontal-nav-item:hover {
      background: #bbdefb;
      color: #1976d2;
    }
    .horizontal-nav-item.active {
      color: #fff;
      background: #9b59b6;
    }

    .tab-content {
      background: #121212;
      padding: 1.5rem;
      border-radius: 0 8px 8px 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      color: #ddd;
      overflow-x: hidden; /* Prevent horizontal overflow */
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: 3fr 1fr;
      gap: 1.5rem;
    }
    .chart-card, .panel-card {
      background: #222;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      box-shadow: 0 1px 6px rgba(0,0,0,0.7);
      color: #ddd;
    }
    .chart-title {
      font-weight: 700;
      margin-bottom: 0.5rem;
      color: #9b59b6;
    }
    .filter-group {
      margin-bottom: 1rem;
    }
    .filter-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }
    select.form-select {
      width: 100%;
    }
    .admin-panel-stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 1rem;
    }
    .stat-item {
      text-align: center;
    }
    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: #4b0082;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #aaa;
    }
    .btn-primary, .btn-secondary, .btn-success {
      width: 100%;
      margin-bottom: 0.5rem;
    }
    .user-card {
      background: #222;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 6px rgba(0,0,0,0.7);
      color: #ddd;
    }
    .user-card h5 {
      color: #9b59b6;
      margin-bottom: 0.5rem;
    }
    .user-card p {
      margin: 0.3rem 0;
      color: #aaa;
    }
    .user-card .btn-danger {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .user-card .btn-danger:hover {
      background: #c82333;
    }
    .users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
  </style>

<div class="container">
  <div class="horizontal-nav">
    <div class="horizontal-nav-item active" data-tab="dashboard">Dashboard</div>
    <div class="horizontal-nav-item" data-tab="analytics">Analytics</div>
    <div class="horizontal-nav-item" data-tab="admin">Admin</div>
    <div class="horizontal-nav-item" data-tab="settings">Settings</div>
  </div>
  <div class="main-content">
    <div class="tab-content" id="dashboard" style="display: block;">
      <div class="dashboard-grid">
        <div class="chart-card">
          <div class="chart-title">Sentiment Trends Over Time</div>
          <canvas id="sentimentTrendsChart" height="100"></canvas>
          <div class="chart-title" style="margin-top: 1rem;">Top Aspects by Sentiment</div>
          <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <div style="flex: 1;">
              <h5 style="color: #22c55e; margin-bottom: 0.5rem;">Top Positive Aspects</h5>
              <canvas id="topPositiveAspectsChart" height="200"></canvas>
            </div>
            <div style="flex: 1;">
              <h5 style="color: #dc3545; margin-bottom: 0.5rem;">Top Negative Aspects</h5>
              <canvas id="topNegativeAspectsChart" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="panel-card">
          <div class="filter-group">
            <label for="filterCategory">Product Category</label>
            <select id="filterCategory" class="form-select">
              <option value="all">All Categories</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterTimeRange">Time Range</label>
            <select id="filterTimeRange" class="form-select">
              <option value="7">Last 7 Days</option>
              <option value="30">Last 30 Days</option>
              <option value="90">Last 90 Days</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="filterSentiment">Sentiment</label>
            <select id="filterSentiment" class="form-select">
              <option value="all">All</option>
              <option value="positive">Positive</option>
              <option value="negative">Negative</option>
              <option value="neutral">Neutral</option>
            </select>
          </div>
          <hr>
          <div class="admin-panel-stats">
            <div class="stat-item">
              <div class="stat-number" id="statReviews">0</div>
              <div class="stat-label">Reviews</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="statAspects">0</div>
              <div class="stat-label">Aspects</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="statAccuracy">0%</div>
              <div class="stat-label">Accuracy</div>
            </div>
          </div>
          <button class="btn btn-secondary" id="btnExportData">Export Data</button>
          <button class="btn btn-success" id="btnReadyDeployment">Ready for Deployment</button>
        </div>
      </div>
    </div>

    <div class="tab-content" id="analytics" style="display: none;">
    <div style="display: grid; grid-template-columns: 1.8fr 0.6fr; gap: 1rem; height: calc(100vh - 240px); overflow-x: hidden;">
      <!-- Left side: Reviews list -->
      <div style="background: #121212; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); border: 1px solid #444; display: flex; flex-direction: column; overflow-x: hidden;">
        <h3 style="border-bottom: 1px solid #9b59b6; padding-bottom: 0.5rem; margin-bottom: 1rem; color: #ddd;">
          Displayed Reviews (<span id="reviewCount">0</span>)
        </h3>
        <div id="reviewList" style="flex: 1; overflow-y: auto; overflow-x: hidden;">
          <!-- Reviews will be loaded here -->
        </div>
      </div>
      <!-- Right side: Vertical container with sentiment info -->
      <div style="background: #222; padding: 0.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); border: 1px solid #444; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; gap: 0.5rem; flex: 0.7; max-width: 260px;">
        <h3 style="margin-bottom: 0.3rem; font-size: 0.9rem; color: #ddd;">Overall Sentiment</h3>
        <canvas id="sentimentPieChart" style="width: 250px; height: 250px;"></canvas>
        <div style="width: 100%;">
          <h4 style="color: #9b59b6; margin-bottom: 0.3rem;">Sentiment Breakdown</h4>
          <div style="font-size: 1rem; font-weight: 600; color: #ddd; display: flex; flex-direction: column; gap: 3px;">
            <div>Total Reviews: <span id="totalReviews">0</span></div>
            <div style="color: #22c55e;">Positive: <span id="positivePercent">0%</span></div>
            <div style="color: #dc3545;">Negative: <span id="negativePercent">0%</span></div>
            <div style="color: #facc15;">Neutral: <span id="neutralPercent">0%</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="admin" style="display: none;">
    <h3>Admin Panel - All Users</h3>
    <div id="adminUserList">
      <!-- Users will be loaded here -->
    </div>
  </div>

  <div class="tab-content" id="settings" style="display: none;">
    <h3 style="color: #9b59b6; margin-bottom: 1rem;">Settings</h3>
    <div style="display: flex; justify-content: center;">
      <div style="background: #f3e5f5; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 1px solid #ccc; max-width: 600px; width: 100%;">
        <div style="border-bottom: 1px solid #9b59b6; padding-bottom: 1rem; margin-bottom: 1.5rem;">
          <h5 style="color: #9b59b6; margin: 0; font-weight: 700;">Change Password</h5>
        </div>
        <div style="margin-bottom: 1.5rem;">
          <p style="color: #666; margin: 0;">Update your password to keep your account secure.</p>
        </div>
        <div id="passwordChangeMessage" style="margin-bottom: 1rem;"></div>
        <form id="changePasswordForm">
          <div style="margin-bottom: 1rem;">
            <label for="current_password" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Current Password</label>
            <input type="password" id="current_password" name="current_password" required placeholder="Enter your current password" style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; color: #333; font-size: 1rem;">
          </div>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <div style="flex: 1;">
              <label for="new_password" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">New Password</label>
              <input type="password" id="new_password" name="new_password" required minlength="6" placeholder="Enter new password" style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; color: #333; font-size: 1rem;">
            </div>
            <div style="flex: 1;">
              <label for="confirm_password" style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #333;">Confirm New Password</label>
              <input type="password" id="confirm_password" name="confirm_password" required minlength="6" placeholder="Confirm new password" style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; background: #fff; color: #333; font-size: 1rem;">
            </div>
          </div>
          <button type="submit" id="changePasswordBtn" style="width: 100%; padding: 0.75rem; background: linear-gradient(90deg, #9b59b6, #4B0082); color: white; border: none; border-radius: 4px; font-size: 1rem; font-weight: 600; cursor: pointer;">Update Password</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Dynamic data for charts
  const sentimentTrendsCtx = document.getElementById('sentimentTrendsChart').getContext('2d');
  const sentimentTrendsChart = new Chart(sentimentTrendsCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Positive',
          data: [],
          borderColor: '#22c55e',
          fill: true,
          backgroundColor: 'rgba(34, 197, 94, 0.2)',
          tension: 0.3
        },
        {
          label: 'Negative',
          data: [],
          borderColor: '#dc3545',
          fill: true,
          backgroundColor: 'rgba(220, 53, 69, 0.2)',
          tension: 0.3
        },
        {
          label: 'Neutral',
          data: [],
          borderColor: '#facc15',
          fill: true,
          backgroundColor: 'rgba(250, 204, 21, 0.2)',
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } }
      }
    }
  });

  // Fetch and update admin stats
  async function fetchAdminStats() {
    const res = await fetch('/admin/api/admin_stats', { credentials: 'include' });
    const data = await res.json();
    document.getElementById('statReviews').textContent = data.reviews;
    document.getElementById('statAspects').textContent = data.aspects;
    document.getElementById('statAccuracy').textContent = data.accuracy + '%';
  }

  // Fetch and update sentiment trends chart
  async function fetchSentimentTrends() {
    const category = document.getElementById('filterCategory').value;
    const timeRange = document.getElementById('filterTimeRange').value;
    const sentiment = document.getElementById('filterSentiment').value;

    const res = await fetch(`/admin/api/sentiment_trends?category=${category}&time_range=${timeRange}&sentiment=${sentiment}`, { credentials: 'include' });
    const data = await res.json();

    sentimentTrendsChart.data.labels = data.dates;
    sentimentTrendsChart.data.datasets[0].data = data.positive;
    sentimentTrendsChart.data.datasets[1].data = data.negative;
    sentimentTrendsChart.data.datasets[2].data = data.neutral;
    sentimentTrendsChart.update();
  }

  // Fetch and update top aspects bar charts
  async function fetchAspectSentimentDistribution() {
    const category = document.getElementById('filterCategory').value;
    const timeRange = document.getElementById('filterTimeRange').value;
    const sentiment = document.getElementById('filterSentiment').value;

    const res = await fetch(`/admin/api/aspect_sentiment_distribution?category=${category}&time_range=${timeRange}&sentiment=${sentiment}`, { credentials: 'include' });
    const data = await res.json();

    console.log("Aspect Sentiment Distribution Data:", data);  // Added log for debugging

    // Positive aspects bar chart
    const positiveCtx = document.getElementById('topPositiveAspectsChart').getContext('2d');
    if (window.positiveAspectsChart) {
      window.positiveAspectsChart.destroy();
    }
    if (data.top_positive_aspects && data.top_positive_aspects.length > 0) {
      const labels = data.top_positive_aspects.map(a => a.aspect);
      const values = data.top_positive_aspects.map(a => a.avg_confidence * 100);
      window.positiveAspectsChart = new Chart(positiveCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Confidence (%)',
            data: values,
            backgroundColor: '#22c55e',
            borderColor: '#22c55e',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    } else {
      positiveCtx.font = '16px Arial';
      positiveCtx.fillStyle = '#666';
      positiveCtx.textAlign = 'center';
      positiveCtx.fillText('No positive aspects found', positiveCtx.canvas.width / 2, positiveCtx.canvas.height / 2);
    }

    // Negative aspects bar chart
    const negativeCtx = document.getElementById('topNegativeAspectsChart').getContext('2d');
    if (window.negativeAspectsChart) {
      window.negativeAspectsChart.destroy();
    }
    if (data.top_negative_aspects && data.top_negative_aspects.length > 0) {
      const labels = data.top_negative_aspects.map(a => a.aspect);
      const values = data.top_negative_aspects.map(a => a.avg_confidence * 100);
      window.negativeAspectsChart = new Chart(negativeCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Confidence (%)',
            data: values,
            backgroundColor: '#dc3545',
            borderColor: '#dc3545',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    } else {
      negativeCtx.font = '16px Arial';
      negativeCtx.fillStyle = '#666';
      negativeCtx.textAlign = 'center';
      negativeCtx.fillText('No negative aspects found', negativeCtx.canvas.width / 2, negativeCtx.canvas.height / 2);
    }
  }

  // Fetch and populate product categories filter (assuming categories are from aspect_categories)
  async function fetchProductCategories() {
    const res = await fetch('/admin/api/aspect_categories', { credentials: 'include' });
    const categories = await res.json();
    const select = document.getElementById('filterCategory');
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat.name;
      option.textContent = cat.name;
      select.appendChild(option);
    });
  }

  // Export data button click handler
  document.getElementById('btnExportData').addEventListener('click', () => {
    // Prompt user for format
    const format = prompt('Enter export format (excel or pdf):', 'excel');
    if (!format) return;
    const url = `/admin/export_data?format=${format.toLowerCase()}`;
    window.open(url, '_blank');
  });

  // Ready for Deployment button click handler (placeholder)
  document.getElementById('btnReadyDeployment').addEventListener('click', () => {
    alert('Ready for Deployment feature coming soon!');
  });

  // Event listeners for filters
  document.getElementById('filterCategory').addEventListener('change', () => {
    fetchSentimentTrends();
    fetchAspectSentimentDistribution();
    fetchAdminStats();
  });
  document.getElementById('filterTimeRange').addEventListener('change', () => {
    fetchSentimentTrends();
    fetchAspectSentimentDistribution();
    fetchAdminStats();
  });
  document.getElementById('filterSentiment').addEventListener('change', () => {
    fetchSentimentTrends();
    fetchAspectSentimentDistribution();
    fetchAdminStats();
  });

  // Fetch and display users in settings tab
  async function fetchUsers() {
    const res = await fetch('/admin/api/users', { credentials: 'include' });
    const data = await res.json();
    const users = data.users || [];
    const usersList = document.getElementById('usersList');
    if (users.length === 0) {
      usersList.innerHTML = '<p style="color: #aaa; text-align: center;">No users found.</p>';
      return;
    }
    // Render users as cards in a grid
    usersList.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'users-grid';
    users.forEach(user => {
      const card = document.createElement('div');
      card.className = 'user-card';
      card.innerHTML = `
        <h5>${user.username} (ID: ${user.user_id})</h5>
        <p><strong>Email:</strong> ${user.email}</p>
        <p><strong>Created At:</strong> ${user.created_at}</p>
        <button class="btn-danger" onclick="deleteUser(${user.user_id})">Delete</button>
      `;
      grid.appendChild(card);
    });
    usersList.appendChild(grid);
  }

  // Delete user function
  async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;
    const res = await fetch(`/admin/api/users/${userId}`, { method: 'DELETE', credentials: 'include' });
    if (res.ok) {
      alert('User deleted successfully');
      fetchUsers(); // Refresh the list
    } else {
      const err = await res.json();
      alert('Error: ' + (err.error || 'Failed to delete user'));
    }
  }

  // Combined tab switching logic
  document.querySelectorAll('.horizontal-nav-item').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.horizontal-nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(tc => tc.style.display = 'none');
      document.getElementById(item.dataset.tab).style.display = 'block';
      if (item.dataset.tab === 'admin') {
        fetchAdminUsers();
      }
      if (item.dataset.tab === 'analytics') {
        fetchAnalyticsData();
      }
    });
  });

  // Initial load
  fetchProductCategories().then(() => {
    fetchSentimentTrends();
    fetchAspectSentimentDistribution();
    fetchAdminStats();
  });

  // Analytics tab: fetch and render sentiment distribution and reviews
  async function fetchAnalyticsData() {
    try {
      const res = await fetch('/admin/api/analytics_data', { credentials: 'include' });
      if (!res.ok) {
        console.error('API error:', res.status, res.statusText);
        return;
      }
      const data = await res.json();
      console.log('Fetched data:', data);

      const reviews = data.reviews || [];
      // Compute sentiment counts from displayed reviews array
      const sentimentCounts = { positive: 0, negative: 0, neutral: 0 };
      reviews.forEach(r => {
        let sentimentRaw = (r.overall_sentiment || 'neutral').toLowerCase();
        // Map sentiment variations to expected keys
        let sentiment = 'neutral';
        if (sentimentRaw.includes('pos')) {
          sentiment = 'positive';
        } else if (sentimentRaw.includes('neg')) {
          sentiment = 'negative';
        } else if (sentimentRaw.includes('neu')) {
          sentiment = 'neutral';
        }
        console.log('Mapped sentiment:', sentimentRaw, '->', sentiment);
        sentimentCounts[sentiment]++;
      });
      const totalReviews = reviews.length;
      document.getElementById('totalReviews').textContent = totalReviews;
      console.log('Computed sentiment counts:', sentimentCounts);
      console.log('Total reviews:', totalReviews);

      // Pie chart for sentiment distribution
      const ctx = document.getElementById('sentimentPieChart').getContext('2d');
      if (window.sentimentPieChartInstance) {
        window.sentimentPieChartInstance.destroy();
      }
      if (totalReviews > 0) {
        // Calculate percentages
        const positivePercent = ((sentimentCounts.positive / totalReviews) * 100).toFixed(1);
        const negativePercent = ((sentimentCounts.negative / totalReviews) * 100).toFixed(1);
        const neutralPercent = ((sentimentCounts.neutral / totalReviews) * 100).toFixed(1);

        // Update percentage text elements
        document.getElementById('positivePercent').textContent = positivePercent + '%';
        document.getElementById('negativePercent').textContent = negativePercent + '%';
        document.getElementById('neutralPercent').textContent = neutralPercent + '%';

        window.sentimentPieChartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Positive', 'Negative', 'Neutral'],
            datasets: [{
              data: [
                sentimentCounts.positive,
                sentimentCounts.negative,
                sentimentCounts.neutral
              ],
              backgroundColor: ['#22c55e', '#dc3545', '#facc15']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            animation: false
          }
        });
      } else {
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No reviews available for chart', ctx.canvas.width / 2, ctx.canvas.height / 2);
      }

      // Render reviews list with tabs
      document.getElementById('reviewCount').textContent = reviews.length;
      const reviewList = document.getElementById('reviewList');
      reviewList.innerHTML = '';
      console.log('Reviews:', reviews);

      if (reviews.length === 0) {
        reviewList.innerHTML = '<p style="color: #aaa; text-align: center;">No reviews available.</p>';
      } else {
        reviews.forEach((r, index) => {
          // Create review card container
          const card = document.createElement('div');
          card.style.border = '1px solid #444';
          card.style.borderRadius = '8px';
          card.style.padding = '1rem';
          card.style.marginBottom = '1rem';
          card.style.backgroundColor = '#222';

          // Username display
          const usernameSpan = document.createElement('span');
          usernameSpan.textContent = `User: ${r.username || 'Unknown'}`;
          usernameSpan.style.fontWeight = '700';
          usernameSpan.style.marginRight = '1rem';
          usernameSpan.style.color = '#ddd';

          // Sentiment label and confidence
          const sentimentLabel = r.overall_sentiment ? r.overall_sentiment.charAt(0).toUpperCase() + r.overall_sentiment.slice(1) : 'Neutral';
          const sentimentNormalized = (r.overall_sentiment || 'neutral').toLowerCase().trim();
          const sentimentColor = sentimentNormalized === 'positive' ? '#22c55e' : (sentimentNormalized === 'negative' ? '#dc3545' : '#facc15');

          const sentimentBadge = document.createElement('span');
          sentimentBadge.textContent = sentimentLabel;
          sentimentBadge.style.backgroundColor = sentimentColor;
          sentimentBadge.style.color = 'white';
          sentimentBadge.style.padding = '0.3rem 0.6rem';
          sentimentBadge.style.borderRadius = '12px';
          sentimentBadge.style.fontWeight = '600';
          sentimentBadge.style.marginRight = '1rem';

          const confidenceSpan = document.createElement('span');
          confidenceSpan.textContent = `Confidence: ${(r.overall_sentiment_score * 100).toFixed(1)}%`;
          confidenceSpan.style.color = '#aaa';

          // Expand button for detailed analysis
          const expandBtn = document.createElement('button');
          expandBtn.textContent = 'Show Details';
          expandBtn.style.padding = '0.3rem 0.6rem';
          expandBtn.style.border = '1px solid #666';
          expandBtn.style.borderRadius = '4px';
          expandBtn.style.cursor = 'pointer';
          expandBtn.style.backgroundColor = '#333';
          expandBtn.style.color = '#ddd';
          expandBtn.style.marginLeft = 'auto';
          expandBtn.style.display = 'block';
          expandBtn.style.marginTop = '0.5rem';

          // Tabs container (initially hidden)
          const tabsContainer = document.createElement('div');
          tabsContainer.style.marginTop = '0.5rem';
          tabsContainer.style.display = 'none';

          // Tab buttons
          const tabNames = ['Original', 'Cleaned', 'Tokenized', 'Processed'];
          const tabButtons = document.createElement('div');
          tabButtons.style.display = 'flex';
          tabButtons.style.gap = '0.5rem';
          tabButtons.style.marginBottom = '0.5rem';

          // Tab contents
          const tabContents = document.createElement('div');
          tabContents.style.border = '1px solid #666';
          tabContents.style.borderRadius = '6px';
          tabContents.style.padding = '0.5rem';
          tabContents.style.backgroundColor = '#121212';
          tabContents.style.whiteSpace = 'pre-wrap';
          tabContents.style.fontFamily = 'monospace';
          tabContents.style.fontSize = '0.9rem';
          tabContents.style.maxHeight = '150px';
          tabContents.style.overflowY = 'auto';

          // Loading indicator
          const loadingDiv = document.createElement('div');
          loadingDiv.textContent = 'Loading detailed analysis...';
          loadingDiv.style.color = '#aaa';
          loadingDiv.style.textAlign = 'center';
          loadingDiv.style.display = 'none';

          // Helper to set active tab
          let activeTab = 'Original';
          let detailedData = null;

          function setActiveTab(tabName) {
            activeTab = tabName;
            tabButtons.querySelectorAll('button').forEach(btn => {
              btn.style.backgroundColor = btn.textContent === tabName ? '#9b59b6' : '#222';
              btn.style.color = btn.textContent === tabName ? 'white' : '#ddd';
            });
            updateTabContent();
          }

          // Update tab content
          function updateTabContent() {
            if (!detailedData && activeTab !== 'Original') {
              tabContents.textContent = 'Click "Show Details" to load analysis';
              return;
            }

            let content = '';
            switch (activeTab) {
              case 'Original':
                content = r.review_text;
                break;
              case 'Cleaned':
                content = detailedData ? (detailedData.clean_text || 'N/A') : 'N/A';
                break;
              case 'Tokenized':
                content = detailedData ? (detailedData.aspects ? detailedData.aspects.join(', ') : 'N/A') : 'N/A';
                break;
              case 'Processed':
                content = detailedData ? (detailedData.highlighted_text || 'N/A') : 'N/A';
                break;
            }
            if (activeTab === 'Processed') {
              tabContents.innerHTML = content;
            } else {
              tabContents.textContent = content;
            }
          }

          // Expand button click handler
          expandBtn.addEventListener('click', async () => {
            if (tabsContainer.style.display === 'none') {
              // Show loading
              loadingDiv.style.display = 'block';
              expandBtn.disabled = true;
              expandBtn.textContent = 'Loading...';

              try {
                // Fetch detailed analysis
                const res = await fetch(`/admin/api/review_analysis/${r.review_id}`, { credentials: 'include' });
                if (res.ok) {
                  detailedData = await res.json();
                  tabsContainer.style.display = 'block';
                  expandBtn.textContent = 'Hide Details';
                  updateTabContent();
                } else {
                  console.error('Failed to fetch detailed analysis');
                  tabContents.textContent = 'Failed to load detailed analysis';
                }
              } catch (error) {
                console.error('Error fetching detailed analysis:', error);
                tabContents.textContent = 'Error loading detailed analysis';
              } finally {
                loadingDiv.style.display = 'none';
                expandBtn.disabled = false;
              }
            } else {
              // Hide details
              tabsContainer.style.display = 'none';
              expandBtn.textContent = 'Show Details';
            }
          });

          // Create tab buttons
          tabNames.forEach(name => {
            const btn = document.createElement('button');
            btn.textContent = name;
            btn.style.padding = '0.3rem 0.6rem';
            btn.style.border = '1px solid #666';
            btn.style.borderRadius = '4px';
            btn.style.cursor = 'pointer';
            btn.style.backgroundColor = name === 'Original' ? '#9b59b6' : '#222';
            btn.style.color = name === 'Original' ? 'white' : '#ddd';
            btn.addEventListener('click', () => setActiveTab(name));
            tabButtons.appendChild(btn);
          });

          // Assemble card
          card.appendChild(usernameSpan);
          card.appendChild(sentimentBadge);
          card.appendChild(confidenceSpan);
          card.appendChild(expandBtn);
          card.appendChild(loadingDiv);
          card.appendChild(tabsContainer);
          tabsContainer.appendChild(tabButtons);
          tabsContainer.appendChild(tabContents);

          // Initialize first tab
          updateTabContent();

          reviewList.appendChild(card);
        });
      }
    } catch (error) {
      console.error('Error fetching analytics data:', error);
    }
  }

  // Fetch and render users in admin tab
  async function fetchAdminUsers() {
    const res = await fetch('/admin/api/users', { credentials: 'include' });
    const data = await res.json();
    const users = data.users || [];
    const adminUserList = document.getElementById('adminUserList');
    if (users.length === 0) {
      adminUserList.innerHTML = '<p style="color: #aaa; text-align: center;">No users found.</p>';
      return;
    }
    // Render users as cards in a grid
    adminUserList.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'users-grid';
    users.forEach(user => {
      const card = document.createElement('div');
      card.className = 'user-card';
      card.innerHTML = `
        <h5>${user.username} (ID: ${user.user_id})</h5>
        <p><strong>Email:</strong> ${user.email}</p>
        <p><strong>Created At:</strong> ${user.created_at}</p>
        <button class="btn-danger" onclick="deleteUser(${user.user_id})">Delete</button>
      `;
      grid.appendChild(card);
    });
    adminUserList.appendChild(grid);
  }

  // Password change form handler
  document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;

    if (newPassword !== confirmPassword) {
      document.getElementById('passwordChangeMessage').innerHTML = '<div style="color: #dc3545;">New passwords do not match.</div>';
      return;
    }

    const res = await fetch('/admin/api/change_password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
    });

    const data = await res.json();
    if (res.ok) {
      document.getElementById('passwordChangeMessage').innerHTML = '<div style="color: #22c55e;">Password changed successfully.</div>';
      document.getElementById('changePasswordForm').reset();
    } else {
      document.getElementById('passwordChangeMessage').innerHTML = `<div style="color: #dc3545;">${data.error || 'Failed to change password.'}</div>`;
    }
  });
</script>
{% endblock %}

